<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CV Results - CVision</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        body {
            background-color: #f4f6f9;
        }

        .results-wrapper {
            max-width: 1400px;
            margin: 100px auto 60px;
            padding: 20px;
        }

        .results-header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #333;
        }

        .results-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .results-card {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .results-card h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .results-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .placeholder-box {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 6px;
            color: #999;
        }

        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .metric-card {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .metric-card .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #6BA3D5;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .results-grid,
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/">
            <img src="assets/logo.png" alt="CVision Logo">
        </a>

        <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/dashboard">Upload CV</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Jobs</a></li>
             <li class="nav-item ms-3" id="profileNav" style="display:none;">
                    <a href="/profile" class="profile-btn">
                        <img src="https://cdn.jsdelivr.net/npm/bootstrap-icons/icons/person-circle.svg" alt="Profile">
                    </a>
                </li>
        </ul>
    </div>
</nav>

<!-- RESULTS -->
<div class="results-wrapper">
    
    <div class="results-header">
        <h1>CV Results Page</h1>
        <p id="userInfo">USER NAME & CV ANALYSIS DATE</p>
    </div>

    <div class="results-grid">
        <!-- Skills Level Results -->
        <div class="results-card">
            <h2>Skills Level Results</h2>
            <p>Bar charts showing skill levels assessed using Bloom's Taxonomy. Click for more</p>
            <canvas id="skillsChart"></canvas>
        </div>

        <!-- Skills Coverage by Category -->
        <div class="results-card">
            <h2>Skills Coverage by Category</h2>
            <p>Pie chart, technical skills, soft skills etc.</p>
            <div class="placeholder-box">
                <i class="bi bi-pie-chart fs-1"></i>
                <p class="mt-3 mb-0">Category analysis coming soon</p>
            </div>
        </div>
    </div>

    <!-- Top Skills Compared to Target Job -->
    <div class="bottom-grid">
        <div class="results-card">
            <h2>Top Skills Compared to Target Job Requirements</h2>
            <p>Comparing user proficiency to their target job requirements</p>
            <div class="placeholder-box">
                <i class="bi bi-bar-chart fs-1"></i>
                <p class="mt-3 mb-0">Job comparison features coming soon</p>
            </div>
        </div>
    </div>

    <!-- Experience & Readiness Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Experience Relevance Score</h3>
            <div class="metric-value">85%</div>
            <p class="text-muted">relevant to target industry</p>
        </div>

        <div class="metric-card">
            <h3>Readiness Percentage</h3>
            <div class="metric-value">78%</div>
            <p class="text-muted">ready for desired role</p>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const resultsData = JSON.parse(sessionStorage.getItem('cvResults'));

    if (!resultsData) {
        alert('No CV results found. Please upload a CV first.');
        window.location.href = '/dashboard';
    }

    // Display user info with date
    const today = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    document.getElementById('userInfo').textContent = `Analysis completed on ${today}`;

    const skills = resultsData.skills || [];
    const skillNames = skills.map(s => s.name);
    const skillScores = skills.map(s => s.score);

    // Create Skills Bar Chart
    const skillsCtx = document.getElementById('skillsChart').getContext('2d');
    new Chart(skillsCtx, {
        type: 'bar',
        data: {
            labels: skillNames,
            datasets: [{
                label: 'Bloom\'s Taxonomy Level (1-10)',
                data: skillScores,
                backgroundColor: 'rgba(107, 163, 213, 0.8)',
                borderColor: 'rgba(107, 163, 213, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: '#e0e0e0'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 11,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const skill = skills[context.dataIndex];
                            return [
                                `Confidence: ${skill.confidence}`,
                                `Basis: ${skill.basis}`
                            ];
                        }
                    }
                }
            }
        }
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        
        if (confirm('Are you sure you want to logout?')) {
            try {
               await fetch('/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';

            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    });
</script>
<script>
async function updateNavbar() {
    try {
        const res = await fetch('/session-info', { credentials: 'include' });
        const data = await res.json();

        const profileNav = document.getElementById('profileNav');

        if (data.loggedIn) {
            profileNav.style.display = 'flex';
        } else {
            profileNav.style.display = 'none';
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Navbar session check failed', err);
    }
}

document.addEventListener('DOMContentLoaded', updateNavbar);
</script>

</body>
</html>